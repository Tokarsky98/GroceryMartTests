---
name: Playwright Tests
on:
    push:
        branches: [ main, master ]
    pull_request:
        branches: [ main, master ]
    workflow_dispatch:
    # schedule:
    #     - cron: '5 6 * * 1-5'

concurrency:
    group: playwright-tests-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    checks: write
    id-token: write

jobs:
    run_tests:
        timeout-minutes: 15
        runs-on: ubuntu-latest
        steps:
            - name: Checkout test repository
              uses: actions/checkout@v4
              with:
                  path: tests
            - name: Checkout application repository
              uses: actions/checkout@v4
              with:
                  repository: Tokarsky98/GroceryMartAI
                  token: ${{ secrets.APP_REPO_TOKEN }}
                  path: app
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'npm'
                  cache-dependency-path: tests/package-lock.json
            - name: Get installed Playwright version
              id: playwright-version
              working-directory: tests
              run: echo "PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages?.['node_modules/@playwright/test']?.version)")" >> $GITHUB_ENV
            - name: Cache playwright binaries
              uses: actions/cache@v4
              id: playwright-cache
              with:
                  path: |
                      ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}
            - name: Cache node_modules (tests)
              uses: actions/cache@v4
              id: node-cache-tests
              with:
                  path: |
                      tests/node_modules
                  key: node_modules-tests-${{ hashFiles('tests/package-lock.json') }}
            - name: Cache node_modules (backend)
              uses: actions/cache@v4
              id: node-cache-backend
              with:
                  path: app/backend/node_modules
                  key: node_modules-backend-${{ hashFiles('app/backend/package-lock.json') }}
            - name: Cache node_modules (frontend)
              uses: actions/cache@v4
              id: node-cache-frontend
              with:
                  path: app/frontend/node_modules
                  key: node_modules-frontend-${{ hashFiles('app/frontend/package-lock.json') }}
            - name: Install test dependencies
              if: steps.node-cache-tests.outputs.cache-hit != 'true'
              working-directory: tests
              run: npm ci
            - name: Install Playwright Browsers
              if: steps.playwright-cache.outputs.cache-hit != 'true'
              working-directory: tests
              run: npx playwright install --with-deps
            - name: Install backend dependencies
              if: steps.node-cache-backend.outputs.cache-hit != 'true'
              working-directory: app/backend
              run: npm ci
            - name: Install frontend dependencies
              if: steps.node-cache-frontend.outputs.cache-hit != 'true'
              working-directory: app/frontend
              run: npm ci
            - name: Start backend server
              working-directory: app/backend
              env:
                  PORT: 5000
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  NODE_ENV: development
              run: |
                  npm run dev &
                  npx wait-on http://localhost:5000 --timeout 30000
            - name: Start frontend server
              working-directory: app/frontend
              env:
                  REACT_APP_API_URL: http://localhost:5000/api
              run: |
                  npm start &
                  npx wait-on http://localhost:3000 --timeout 30000
            - name: Run tests
              working-directory: tests
              env:
                  BASE_URL: http://localhost:3000
                  ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
                  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
                  USER_EMAIL: ${{ secrets.USER_EMAIL }}
                  USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
              run: npm run test -- --retries=1
            - name: Archive test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-reports
                  path: |
                      tests/playwright-report/**/*.*
                      tests/test-results/**/*.*
                  retention-days: 7
            - name: Publish all test report
              if: success() || failure()
              uses: mikepenz/action-junit-report@v5
              with:
                  report_paths: 'tests/playwright-report/results.xml'
